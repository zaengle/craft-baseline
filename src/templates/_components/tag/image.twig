{#-
  Image Tag
#}
{# image: (?Asset) #}
{%- do defineProps(data, {
  image: null,
  alt: ''
}) %}

{#-
  ##
  # Opts
  ##
  attrs: HTML attrs hash - you will usually want to include at least a `sizes` key here
  maxW: (int) mxn px width image will display at, used to calculate srcset sizes + transform width if not provided
  minW: (int) min px width image will display at, used to calculate srcset sizes
  transform: (null|string|array|craft\models\ImageTransform)
  # srcset config (defaults should be fine 99% of the time):
  srcsetEnabled: (bool) toggle output of srcset related attrs
  srcsetSizes: (int[]) override the autogenerated srcset sizes. ignored if srcsetEnabled = false
  srcsetStep: (int) range step between srcset sizes, ignored if srcsetSizes passed
#}

{%- do defineProps(opts, {
  tag: 'img',
  attrs: {},
  maxW: 1024,
  minW: 390,
  srcsetEnabled: false,
  srcsetSizes: [],
  srcsetStep: 100,
  transform: null,
}) %}

{%- set image = takeOne(data.image) %}

{%- if image %}
  {#- Transform with defaults #}
  {%- set transform = opts.transform ?? {
    mode: 'crop',
    width: opts.maxW,
  } %}

  {#- Use webp unless they asked not to #}
  {%- if (transform.format ?? null) is empty %}
    {%- set transform = transform|merge({ format: 'webp' }) %}
  {%- endif %}

  {%- do image.setTransform(transform) %}
  {%- if devMode %}
    <!-- transform: {{  transform | json_encode(constant('JSON_PRETTY_PRINT')) |raw }} -->
  {%- endif %}
  {#- srcset config range #}
  {%- set ss = {
    enabled: opts.srcsetEnabled and ((transform.width ?? opts.maxW) > 100),
    min: min(image.width, transform.width ?? null, opts.minW),
    max: min(image.width, max(transform.width ?? null, opts.maxW) * 2),
  }%}

  {#- Dynamically generate a range of srcset sizes #}
  {%- set ssSizes = opts.srcsetSizes ??? null %}

  {%- if not ssSizes %}
    {%-  if (ss.max - ss.min) > opts.srcsetStep %}
      {%- set ssSizes = opts.srcsetSizes ??? range(ss.min, ss.max, opts.srcsetStep) %}
    {%- else %}
      {%- set ssSizes = [ss.max, ss.min] %}
    {%- endif %}
  {%- endif %}
  {%- set attrs = {
    width: image.width,
    height: image.height,
    alt: data.alt ??? image.alt ??? image.title ??? '',
  }  | merge(opts.attrs) %}
  {%- if devMode %}

  {%- endif %}
  {%- if image.extension == 'svg' %}
    {{ svg(image) | attr(opts.attrs | merge({
      'aria-label': data.alt ??? image.alt ??? image.title ??? ''
    })) }}
  {%- else %}
    {{ tag(opts.tag, attrs | merge({
      src: opts.tag == 'img' ? image.url : null,
      sizes: ss.enabled ? (opts.attrs.sizes ?? '100w') : null,
      srcset: ss.enabled ? image.getSrcset(ssSizes) : null,
    })) }}
  {%- endif %}
{%- endif %}
